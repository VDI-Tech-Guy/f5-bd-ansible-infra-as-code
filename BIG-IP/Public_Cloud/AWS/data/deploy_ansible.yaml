---
- name: Deploy F5 BIG-IP HA Pair via CloudFormation (PAYG, us-east-2)
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    stack_name: bigip-ha-demo
    region: us-east-2
    template_file: bigip_ha_3nic.yaml
    keypair_name: bigipKeyPair
    keypair_file: ./bigipKeyPair.pem
    bigip_ami: ami-xxxxxxxxxxxx  # Replace with PAYG AMI ID from AWS Marketplace

  tasks:
    - name: Create new SSH keypair for BIG-IP
      amazon.aws.ec2_key:
        name: "{{ keypair_name }}"
        region: "{{ region }}"
        key_material: "{{ lookup('file', lookup('env','HOME') + '/.ssh/id_rsa.pub') | default(omit) }}"
      register: new_key

    - name: Save generated key to local file
      copy:
        content: "{{ new_key.key.private_key }}"
        dest: "{{ keypair_file }}"
        mode: 0600
      when: new_key.changed

    - name: Launch CloudFormation stack
      amazon.aws.cloudformation:
        stack_name: "{{ stack_name }}"
        region: "{{ region }}"
        state: present
        template: "{{ lookup('file', template_file) }}"
        template_parameters:
          KeyName: "{{ keypair_name }}"
          BigIpImageId: "{{ bigip_ami }}"
        capabilities:
          - CAPABILITY_NAMED_IAM

    - name: Wait for stack to complete
      amazon.aws.cloudformation_info:
        region: "{{ region }}"
        stack_name: "{{ stack_name }}"
      register: stack_info
      until: stack_info.stacks[0].stack_status in ['CREATE_COMPLETE', 'UPDATE_COMPLETE']
      retries: 30
      delay: 60

    - name: Show Management IPs
      debug:
        msg:
          - "AZ1 BIG-IP Management IP: {{ (stack_info.stacks[0].outputs | selectattr('output_key','==','BigIpAz1MgmtIP') | map(attribute='output_value') | first) }}"
          - "AZ2 BIG-IP Management IP: {{ (stack_info.stacks[0].outputs | selectattr('output_key','==','BigIpAz2MgmtIP') | map(attribute='output_value') | first) }}"
