---
- name: Deploy F5 BIG-IP HA Pair via CloudFormation (PAYG, us-east-1)
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    stack_name: bigip-ha-demo
    region: us-east-1
    template_file: bigip_ha_3nic.yaml
    keypair_name: bigipKeyPair
    keypair_file: ./bigipKeyPair.pem
    # bigip_ami: ami-xxxxxxxxxxxx  # Replace with PAYG AMI ID from AWS Marketplace

  tasks:

    - name: Get list of official F5 BIG-IP AMIs
      amazon.aws.ec2_ami_info:
        # aws_access_key: "{{ AWS_ACCESS_KEY_ID }}"
        # aws_secret_key: "{{ AWS_SECRET_ACCESS_KEY }}"
        region: "{{ region }}"
        owners: ["679593333241"]
        filters:
          name: "*BIGIP*{{ bigip_version }}*{{ license_type }}*{{ bigip_features }}*{{ bigip_bandwidth }}*"
      register: f5_amis

    - name: Sort AMIs by CreationDate (latest first)
      ansible.builtin.set_fact:
        latest_ami: "{{ f5_amis.images | sort(attribute='creation_date', reverse=True) | first }}"

    - name: Show latest BIG-IP AMI info
      ansible.builtin.debug:
        msg:
          - "Region: {{ region }}"
          - "Version: {{ bigip_version }}"
          - "License Type: {{ license_type }}"
          - "Latest AMI Name: {{ latest_ami.name }}"
          - "AMI ID: {{ latest_ami.image_id }}"
          - "Creation Date: {{ latest_ami.creation_date }}"
          # - "Instance Type: {{ instance_type }}"

    - name: Create new SSH keypair for BIG-IP, returns generated private key
      # use no_log to avoid private key being displayed into output
      amazon.aws.ec2_key:
        name: "{{ keypair_name }}"
      # no_log: true
      register: new_key

    - name: Save generated key to local file
      ansible.builtin.copy:
        content: "{{ new_key.key.private_key }}"
        dest: "{{ keypair_file }}"
        mode: '0600'
      when: new_key.changed

    - name: Launch CloudFormation stack
      amazon.aws.cloudformation:
        stack_name: "{{ stack_name }}"
        region: "{{ region }}"
        state: present
        template: "{{ lookup('file', template_file) }}"
        template_parameters:
          KeyName: "{{ keypair_name }}"
          BigIpImageId: "{{ latest_ami.image_id }}"
        capabilities:
          - CAPABILITY_NAMED_IAM

    - name: Wait for stack to complete
      amazon.aws.cloudformation_info:
        region: "{{ region }}"
        stack_name: "{{ stack_name }}"
      register: stack_info
      until: stack_info.stacks[0].stack_status in ['CREATE_COMPLETE', 'UPDATE_COMPLETE']
      retries: 30
      delay: 60

    - name: Show Management IPs
      ansible.builtin.debug:
        msg:
          - "AZ1 BIG-IP Management IP: {{ (stack_info.stacks[0].outputs | selectattr('output_key','==','BigIpAz1MgmtIP') | map(attribute='output_value') | first) }}"
          - "AZ2 BIG-IP Management IP: {{ (stack_info.stacks[0].outputs | selectattr('output_key','==','BigIpAz2MgmtIP') | map(attribute='output_value') | first) }}"
